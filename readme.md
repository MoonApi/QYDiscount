QYDiscount 一个简易的优惠券计算框架
============

实际应用场景（类似京东、淘宝、拼多多）的优惠券计算开源方案较少，所以研究了一下支持平行优惠的优惠券计算方案，实现了低内存、高效率的优惠券计算框架，尽可能地穷举所有可能性并剪去了不需要计算的绝大部分分支，同时降低了各类用于检测商品优惠券搭配的检测规则优化器的耦合，分离了各类型优惠券的计算，姑且算是一个框架吧。

注意 QYDiscount 千艺优惠计算框架 仅是一个测试方案，未经过实际生产环境检验，请慎重使用。

---

## 安装

由于当前框架仅是一个测试方案，所以可能更多地需要手动进行。

> php 8.1.2

测试可以使用本地php环境，调用phpunit即可：

>php vendor/bin/phpunit test/DiscountTest.php --filter testDiscount

## 功能
- 平行优惠，当前设计多种类型优惠券（但并未完整实现业务功能，只用于区分阶段）：订单order,跨店铺shops,店铺shop,商品goods,店铺小计subtotal,商品分类category,商品活动营销组bundle,商品组合package,delivery,paid
- 优惠券减免方式支持：折扣、直减、满减、满折、阶梯满减满折、循环满减满等
- 同一类型的优惠券组合及简化
- 某优惠券下所有可用商品的组合及简化  
- 基于同一SKU的多件商品的简化处理

优惠券计算的难点在于：
- 不同类型（可平行优惠）如何组合，在避免冲突（平行优惠券互斥）的情况下，组合达到最终最优解
- 同一类型的优惠券如何组合，在避免冲突（同类型优惠券互斥）的情况下，组合为当前阶段的所有解（涉及平行优惠互斥，不能取局部最优），通过这些解再叠加计算平行优惠的最优解
- 某优惠券如 “满100-30”，支持多个商品，如何选择最优组合（不影响其它优惠券，同时让多张优惠券总优惠金额较佳），能够在平等优惠时获取最优解

综上，计算单张优惠券时不能取最优，需要考虑多张同一类型的优惠券的解，同时在要在优惠券互斥的情况下考虑平行优惠要达到最优，即不能使用局部最优进行全局最优的计算，唯一的办法是穷举所有解，然后得到最优解。

但是穷举的计算量太大了，比如10个商品在两个优惠券下均可用，穷举所有可能性将是灾难性的，但幸运的是，这个简单的例子一眼看下来，就知道很多不需要计算，这时就可以使用检测规则优化器剪掉这些不需要计算的部分，将问题简化。

那么检测规则优化器如何设计呢？需要根不同场景进行设计，注意既要使当前场景使用检测规则优化器能有效简化计算，又要不影响其它场景。

另外计算过程中，既要合理使用缓存，以空间换时间，避免计算过程耗时过多(如不应超过 500ms)，又要尽量降低内存占用（如 30M 每轮计算），以使整个框架更符合实际生产场景的高并发。实际开发过程中也是在不断地实现尽量少的内存占用和尽量短的时间消耗，总的来说就是优化，优化，不停地优化。

## 例子
**上面讲了些什么。。。看不懂。。。那还是举个栗子吧**

#### 一个简单的例子
- 订单中含有同一家店铺A、B、C三件商品，售价均为69元，且均包邮。
- 商品A无法使用任何优惠券，商品B可以使用满60减3元的商品券，商品C可以使用满50减3元的商品券。
- 那么，商品B、C满足满减条件分别优惠3元，最终店铺订单实付金额为201元。

参见：[testDiscount5](test/DiscountTest.php)


#### 一个复杂点的例子
- 商品A售价559元、商品B售价600元、商品C售价198元、商品D售价1600元；
- 商品A、B、C、D均可使用满21减20元、满1000减50元、满2000减100元、满3000减15元0、满5000减350元的店铺优惠券；
- 商品A参加了满300减60元的店铺满减活动、每300减30的跨店活动、拥有一张满300减10服饰券（平台券）；
- 商品B、D参加了满600减30、满1500减130、满2000减200的店铺阶梯满减活动。
- 最终商品A、B、C、D加上各自的优惠金额，分别能优惠118.90、74.84、6.70、199.56；那么商品A、B、C、D实付金额分别为440.10元、525.16元、191.30元、1400.44元。

参见：[testDiscount7](test/DiscountTest.php)


#### 一个再复杂点的例子
- 店铺甲：
- 商品A售价235元(数量2)、商品B售价218元；
- 商品A、商品B都可使用满100减5元、满299减10元、满499减20元、满999减50元店铺优惠券，同时都参加了跨店每满300减30的活动；
- 商品A还可以使用一张满300减10元的服饰券(平台券)；
- 店铺乙：
- 商品C售价799元、商品D售价559元(数量2)、商品E售价479元；
- 商品C、D、E均可使用满21减20、满1000减50、满2000减100、满3000减150、满5000减350的店铺优惠券；
- 商品C可以使用一张满300减10元的服饰券(平台券)、参加每满600减110元的店铺活动；
- 商品D可以使用一张满300减10元的服饰券(平台券)、参加满300减60元的店铺活动；
- 商品E参加满300减30元的店铺活动；
- 商品C、D同时都参加了跨店每满300减30的活动；

参见：[testDiscount8](test/DiscountTest.php)

### 压力测试

testDiscount9 和 testDiscountA1 测试了两种较复杂的情况，testDiscount9 包含100个商品和45个优惠券，testDiscount10 包含了19个商品和均可用的两个优惠券，这两个测试用例均演示了如何使用检测规则优化器将复杂的问题简单化处理，最终在200ms内均能获取最优解。

testDiscountA1看起来比较简单，19件商品售价均为235元， 均能使用“每300减30”或“每300减31”的优惠券，一眼能看出来结果，但条件略微变化一点，如每件商品价格不同，第二张优惠券为“满310减32”，或者增加一个优惠券“满400减45”，情况就会非常复杂。因此需要设计一种能够简化该类型问题的方案，但又不能过于特化，如使用一个简单的优惠率就能决定使用哪张券，避免只能解决这一种特定问题。最终使用的方案是提前计算该类优惠券每个券最大可优惠金额，将不能达到的单张券或券组合都排除，最后问题就非常简单，且能尽可能地适应此类问题。

根据这两个测试用例，也可以看出检测规则优化器是非常重要的，能够将特定场景的问题简化到极致。

## 框架表现
> php vendor/bin/phpunit test/DiscountTest.php --filter testDiscount

> Time: 00:00.400, Memory: 24.00 MB

实际测试全部10个 [testDiscount](test/DiscountTest.php) 用例, 总消耗时间为 400ms， 使用内存 24MB。看起来可接受，就暂时停止优化了。具体日志可参见 test/log 目录中日志文件。

---

## 常见问题
- 是否有详细文档
  
  **暂时没有，写代码是快乐的，写文档不快乐，代码全开源也比较简单，研究下应该容易看懂，代码断断续续写了快3个月，后期可能按需提供价格较高的付费文档进行详解回点血，所以建议自行研究**。


- 代码如何阅读
  
  可以根据test/DiscountTest.php中的测试用例走一走大概的流程，主要在calculator中，调用CartesianProduct等进行穷举组合，使用CheckRuleOptimizer进行优化，数据保存在各种context中，根据这个思路看代码应该比较清晰易懂。


- 能否解决某种优惠券问题

  不确定，当前的检测规则优化器是针对现有的测试用例的，虽然实现过程中尽可能的避免过于特化处理某一类型的问题，但非常可能很容易遇到不适合的场景。  


- 能否提供技术支持

  可以的，协商一下总能找到一个金钱和时间的平衡点的。


- 这个框架很不完善吧，和某某比差太多了

  是的，有可能，当前优惠券计算的开源方案比较少，能参考的也比较少，甚至较全面的测试用例都需要花费大量精力去设计，因此更多地只是提供一种思路，如果没有更好的方案，这个框架也可一试。


- 是否能支持更多语言

  暂时无法支持，仅支持定制开发。虽然使用 PHP 进行实现，但并未有使用其它语言较难实现的部分，同时 PHP 的数组比较占内存，其它语言可以实现更低内存，再有多线程加持，可能效果更好。


- 更多问题
  
  issue可以直接仓库提，技术支持、付费文档可以和 [月萌API](https://www.moonapi.com) [https://www.moonapi.com](https://www.moonapi.com) 网站客服联系（客服不懂技术，不交流单纯技术问题噢）

---

## To Do
- 更多的测试用例
- 更多的检测规则优化器以满足更多场景
- 实现计划引擎，随着场景的复杂化，针对不对的优惠券商品组合情形，某些检测规则优化器可能更有效，计划引擎能够生成代价可接受计算方案

---

## Thanks
- [BenTools\CartesianProduct](https://github.com/bpolaszek/cartesian-product)
- [drupol\phpermutations](https://github.com/drupol/phpermutations/blob/master/src/Generators/Combinations.php) 
- phpunit
- [Q-calculator](https://github.com/CyrilFeng/Q-calculator)


## License

This project is licensed under the terms of the **GPL3** license.


## 欢迎赞助本项目(微信赞赏)
- 通过赞赏请作者喝瓶零度可乐
- 更新完善框架

![](z/zs.jpg)
